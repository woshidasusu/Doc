# 记一次卡顿的性能优化经历实操

本篇的性能优化不是八股文类的优化方案，而是针对具体场景，具体分析，从排查卡顿根因到一步步寻找解决方案，甚至是规避等方案来最终解决性能问题的经历实操

所以，解决方案可能不通用，不适用于你的场景，但这个解决过程是如何一步步去处理的，解决思路是怎么样的，应该还是可以提供一些参考、借鉴意义的

当然，也许你还有更好的解决方案，也欢迎评论教一下，万分感谢

## 问题现象

我基于 `twaver.js` 库实现了一个园区内网络设备的拓扑呈现，连线表示设备间的拓扑关系，线路上支持流动动画、告警动画、链路信息等呈现，如：

![](./images/topo1.gif)

但当呈现的节点数量超过 1000 后，动画开始有点丢帧，操作有点点滞后感

超过 5000 个节点后，页面就非常的卡顿，难以操作

所以，就开始了性能优化之路

## 猜测&验证

### 猜测 1：Vue 框架的响应式处理导致的性能瓶颈

之所以有这个猜测是因为，我在官方给的 demo 上体验时，上万个节点时都不卡顿，更何况是一千个节点而已

而我的项目跟官方 demo 的差异有两块：

- 我用 vue 框架开发，官方 demo 用的纯 html + js
- 我功能已经开发完，所以实际上还参杂了其他各种实现的代码，官方 demo 很简单的纯节点和链路

为了验证这个猜想，我另外搞了个空项目，纯粹就只是把官方 demo 的代码迁移到 vue 上运行起来而已，如：

同样的代码，同样的数据量，两边的耗时差异将近 10 倍

所以就开始思考了，Vue 框架能影响到性能问题的是什么？无非不就是响应式处理，内部会自动对复杂对象深度遍历去配置 setter, getter 来拦截对象属性的读写

而 twaver 的对象结构又非常复杂，但我们又不需要它能够响应式，我们只是想使用 twaver 对象的一些 api 而已

那么该怎么来避免 Vue 对这些数据进行的响应式处理呢？

下一章节里再具体介绍解法，至少到这里已经明确了卡顿的根因之一是 Vue 对 twaver 的数据对象进行了响应式处理而引发的性能瓶颈

### 猜测 2：动画太多导致的性能瓶颈

### 猜测 3：一次性呈现的节点链路太多导致的性能瓶颈

### 猜测 4：dom 节点太多导致的性能瓶颈

## 解决方案

### 绕过 Vue 的自动对数据模型进行的响应式处理

**【举一反三】**

当用到其他一些三方库，三方库变量又不是全局而是当前组件内的局部变量时，都会存在被 Vue 响应式处理的问题。

### 共同复用全局的动画管理器 + 按需刷新

### 交互上进行规避，如增加默认折叠、展开处理

### dom 节点的懒创建 + 缓存和复用

## 小结
