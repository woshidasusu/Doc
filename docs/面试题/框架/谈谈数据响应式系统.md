# 谈谈数据响应式系统

> 本文参考: [现代前端科技解析 —— 数据响应式系统 (Data Reactivity System)]( https://404forest.com/2017/06/28/modern-web-development-tech-analysis-data-reactivity-system/ )

### 概念

数据响应式系统，也就是由数据来驱动的系统

在前端的应用，其实也就是三大框架都实现的双向绑定 MVVM 

双向指的两个方向：

- 视图变化 => 数据模型更新（这个不难，基于原生 DOM 事件回调做层封装即可）
- 数据模型 => 视图变化（这个比较难）

数据模型变化到视图更新这个方向的实现比较难，三大框架都采用不同的方式来解决这个问题

要解决这个问题，其实有两个关键点：

- 框架怎么知道数据模型发生变化的时机？
- 框架怎么知道数据模型变化后需要更新的视图有哪些？

简单说其实就是 when（什么时候）, where（更新哪里）

下面用我粗坯的理解来讲讲三大框架思路：

### Vue

vue 通过将对数据模型做了层处理，即利用 Object.defineProperty 来将对象属性修改成 setter/getter 存取器属性，以及来拦截监听数据模型的读写

这样一来，就解决了 when 的问题，知道了数据模型变化的时机

然后就可以利用发布-订阅模式，当数据模型发生变化时，把这个消息发送出去，通知所有订阅了这个消息去做相应的响应行为，比如更新视图

那么，框架是如何让模板中的这些视图去订阅相应的数据模型变化的消息呢？

vue 是在模板引擎解析期间，会把所有模板代码都编译成一个 render（渲染）函数，渲染函数内保存该模板视图的各种信息，包括使用的数据模型

那么渲染函数在执行时，就会去调用数据模型的 getter 读取初始值，这时候，框架就能够知道，这个数据模型的变化需要刷新的视图了（where），也就将该渲染函数作为响应行为订阅了数据模型的变化消息

大体流程就是这样：

1. 通过 setter 知道数据模型变化时机（when）
2. 通过 getter 知道数据模型变化需要更新的视图有哪些（where）
3. 通过发布-订阅模式，将视图更新的渲染函数跟数据模型变更的消息关联起来

当然，还有很多其他核心的性能优化处理、算法优化等，比如：

- 数组操作的特殊处理
- 响应行为（渲染函数）的去重处理，因为同个视图可能订阅了多个数据模型
- 异步更新队列，因为没必要数据变化就更新视图，完全可以一定频率的批量处理
- 等等

### React

react 思想跟 vue 很类似，要解决同样是 when 和 where

react 通过提供唯一的入口 API 来给用户进行数据模型的变更操作，只有通过这个 API 来修改数据模型，才能有响应式的视图更新，这个就是解决了 when

但 react 并不知道哪些视图使用了哪些数据模型，所以当需要更新视图时，是直接调用了渲染函数重新更新组件

而为了提供效率，引入了虚拟 DOM 的实现

也就是通过 js 维护一份 DOM 树的信息，每次渲染函数被调用，更新视图时，会通过内部的 diff 算法，计算出此次需要更新的视图都有哪些，以此来解决 where 的问题

### Angular

Angular 的思想跟上面两种有些不一样

Angular 想法是，当界面有可能会发生刷新时，重新去检测当前视图里绑定的各个模型，比对看是否需要进行视图更新

那么界面什么时候会发生变化呢？

无外乎也就是网络事件回调、DOM 事件、用户交互、setTimeout 等

所以 Angular 重写了这些方法，当我们进行 DOM 事件注册、网络事件处理时，其实用的都是 Angular 实现的 API，那么这就解决了 when

Angular 在可能会更新界面的各种操作都会去触发检测，这种机制也叫脏数据检查

Angular 在解析模板时，会保存视图里的当前值以及表达式，后续当在检测时，重新执行表达式，来跟上次值做比较，这样就解决了 where 找出那些需要更新的视图